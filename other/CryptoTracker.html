<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>CryptoVision | Crypto Tracker</title>
 <script src="https://cdn.tailwindcss.com"></script>
 <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
 <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
 <script>
  tailwind.config = {
   theme: {
    extend: {
     fontFamily: {
      sans: ['Inter', 'sans-serif'],
     },
     colors: {
      dark: {
       900: '#0f172a',
       800: '#1e293b',
       700: '#334155',
       600: '#475569',
      },
      accent: {
       purple: '#8b5cf6',
       blue: '#3b82f6',
       green: '#10b981',
       red: '#ef4444',
      }
     },
     animation: {
      'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
      'fade-in': 'fadeIn 0.5s ease-out',
      'slide-up': 'slideUp 0.3s ease-out',
     },
     keyframes: {
      fadeIn: {
       '0%': { opacity: '0' },
       '100%': { opacity: '1' },
      },
      slideUp: {
       '0%': { transform: 'translateY(20px)', opacity: '0' },
       '100%': { transform: 'translateY(0)', opacity: '1' },
      }
     }
    }
   }
  }
 </script>
 
 <style>
  ::-webkit-scrollbar {
   width: 8px;
   height: 8px;
  }
  
  ::-webkit-scrollbar-track {
   background: #0f172a;
  }
  
  ::-webkit-scrollbar-thumb {
   background: #334155;
   border-radius: 4px;
  }
  
  ::-webkit-scrollbar-thumb:hover {
   background: #475569;
  }
  
  .glass-panel {
   background: rgba(30, 41, 59, 0.7);
   backdrop-filter: blur(12px);
   -webkit-backdrop-filter: blur(12px);
   border: 1px solid rgba(255, 255, 255, 0.05);
   box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
  }
  
  .glass-header {
   background: rgba(15, 23, 42, 0.85);
   backdrop-filter: blur(10px);
   border-bottom: 1px solid rgba(255, 255, 255, 0.05);
  }
  
  .text-shadow {
   text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
  }
  
  .cursor-pointer-row {
   cursor: pointer;
   transition: background-color 0.2s;
  }
  
  .cursor-pointer-row:hover {
   background-color: rgba(59, 130, 246, 0.1);
  }
  
  .loader {
   border: 3px solid #1e293b;
   border-radius: 50%;
   border-top: 3px solid #3b82f6;
   width: 24px;
   height: 24px;
   -webkit-animation: spin 1s linear infinite;
   animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
   0% {
    transform: rotate(0deg);
   }
   
   100% {
    transform: rotate(360deg);
   }
  }
  
  @keyframes flashGreen {
   0% {
    color: #10b981;
    background-color: rgba(16, 185, 129, 0.2);
   }
   
   100% {
    color: inherit;
    background-color: transparent;
   }
  }
  
  @keyframes flashRed {
   0% {
    color: #ef4444;
    background-color: rgba(239, 68, 68, 0.2);
   }
   
   100% {
    color: inherit;
    background-color: transparent;
   }
  }
  
  .flash-up {
   animation: flashGreen 1s ease-out;
  }
  
  .flash-down {
   animation: flashRed 1s ease-out;
  }
  
  .range-track {
   background: #334155;
   height: 6px;
   border-radius: 3px;
   position: relative;
   overflow: hidden;
  }
  
  .range-fill {
   height: 100%;
   background: linear-gradient(90deg, #ef4444, #eab308, #10b981);
  }
  
  .range-marker {
   position: absolute;
   top: -2px;
   width: 4px;
   height: 10px;
   background: white;
   border: 1px solid black;
   transform: translateX(-50%);
  }
 </style>
</head>

<body class="bg-dark-900 text-gray-200 font-sans min-h-screen flex flex-col">
 
 <!-- Header -->
 <header class="glass-header sticky top-0 z-40 w-full">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
   <div class="flex items-center gap-3">
    <i class="fa-solid fa-layer-group text-accent-blue text-2xl"></i>
    <h1 class="text-xl font-bold tracking-tight text-white">Crypto<span class="text-accent-blue">Vision</span></h1>
   </div>
   
   <div class="hidden md:flex items-center gap-6 text-sm text-gray-400">
    <div class="flex items-center gap-2">
     <span>Global Cap:</span>
     <span id="global-cap" class="text-white font-medium">-</span>
    </div>
    <div class="flex items-center gap-2">
     <span>BTC Dom:</span>
     <span id="btc-dom" class="text-accent-purple font-medium">-</span>
    </div>
   </div>
   
   <div class="flex items-center gap-3">
    <button id="refresh-btn" class="p-2 rounded-lg hover:bg-dark-700 transition text-gray-400 hover:text-white" title="Refresh Data">
     <i class="fa-solid fa-rotate"></i>
    </button>
    <div id="connection-status" class="w-2 h-2 rounded-full bg-accent-green animate-pulse-slow" title="Live Connection"></div>
   </div>
  </div>
 </header>
 
 <!-- Main Content -->
 <main class="flex-grow p-4 sm:p-6 lg:p-8 max-w-7xl mx-auto w-full space-y-6">
  
  <!-- Search & Filter Controls -->
  <section class="flex flex-col md:flex-row gap-4 justify-between items-center glass-panel p-4 rounded-xl">
   <div class="relative w-full md:w-96">
    <i class="fa-solid fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500"></i>
    <input type="text" id="search-input" placeholder="Search coins (e.g., BTC, Ethereum)..." class="w-full bg-dark-800 border border-dark-700 text-white pl-10 pr-4 py-2 rounded-lg focus:outline-none focus:border-accent-blue focus:ring-1 focus:ring-accent-blue transition">
   </div>
   
   <div class="flex gap-2 overflow-x-auto w-full md:w-auto pb-2 md:pb-0 scrollbar-hide">
    <button class="filter-btn active px-4 py-2 rounded-lg text-sm font-medium bg-accent-blue text-white transition whitespace-nowrap" data-filter="all">All Assets</button>
    <button class="filter-btn px-4 py-2 rounded-lg text-sm font-medium bg-dark-800 hover:bg-dark-700 text-gray-300 transition whitespace-nowrap" data-filter="favorites"><i class="fa-solid fa-star text-yellow-500 mr-1"></i> Favorites</button>
    <button class="filter-btn px-4 py-2 rounded-lg text-sm font-medium bg-dark-800 hover:bg-dark-700 text-gray-300 transition whitespace-nowrap" data-filter="gainers"><i class="fa-solid fa-arrow-trend-up text-accent-green mr-1"></i> Gainers</button>
    <button class="filter-btn px-4 py-2 rounded-lg text-sm font-medium bg-dark-800 hover:bg-dark-700 text-gray-300 transition whitespace-nowrap" data-filter="losers"><i class="fa-solid fa-arrow-trend-down text-accent-red mr-1"></i> Losers</button>
   </div>
   
   <select id="currency-select" class="bg-dark-800 border border-dark-700 text-white px-3 py-2 rounded-lg focus:outline-none text-sm">
    <option value="usd">USD ($)</option>
    <option value="eur">EUR (€)</option>
    <option value="gbp">GBP (£)</option>
    <option value="jpy">JPY (¥)</option>
   </select>
  </section>
  
  <!-- Market Highlights Cards -->
  <section class="grid grid-cols-1 md:grid-cols-3 gap-4" id="highlights-section">
   <!-- Dynamically populated -->
   <div class="glass-panel p-4 rounded-xl flex items-center justify-between animate-pulse">
    <div class="h-10 w-32 bg-dark-700 rounded"></div>
   </div>
   <div class="glass-panel p-4 rounded-xl flex items-center justify-between animate-pulse">
    <div class="h-10 w-32 bg-dark-700 rounded"></div>
   </div>
   <div class="glass-panel p-4 rounded-xl flex items-center justify-between animate-pulse">
    <div class="h-10 w-32 bg-dark-700 rounded"></div>
   </div>
  </section>
  
  <!-- Main Data Table -->
  <section class="glass-panel rounded-xl overflow-hidden shadow-lg border border-dark-700">
   <div class="overflow-x-auto">
    <table class="w-full text-left border-collapse">
     <thead class="bg-dark-800 text-gray-400 text-xs uppercase tracking-wider">
      <tr>
       <th class="p-4 w-12 text-center"><i class="fa-solid fa-star"></i></th>
       <th class="p-4 w-16 text-center">#</th>
       <th class="p-4">Asset</th>
       <th class="p-4 text-right cursor-pointer hover:text-white group" onclick="sortBy('current_price')">
        Price <i class="fa-solid fa-sort ml-1 opacity-50 group-hover:opacity-100"></i>
       </th>
       <th class="p-4 text-right cursor-pointer hover:text-white group" onclick="sortBy('price_change_percentage_24h')">
        24h % <i class="fa-solid fa-sort ml-1 opacity-50 group-hover:opacity-100"></i>
       </th>
       <th class="p-4 text-right hidden md:table-cell cursor-pointer hover:text-white group" onclick="sortBy('market_cap')">
        Market Cap <i class="fa-solid fa-sort ml-1 opacity-50 group-hover:opacity-100"></i>
       </th>
       <th class="p-4 text-right hidden lg:table-cell">
        Volume (24h)
       </th>
       <th class="p-4 w-32 hidden sm:table-cell">Last 7 Days</th>
      </tr>
     </thead>
     <tbody id="crypto-table-body" class="text-sm divide-y divide-dark-700">
      <!-- Rows injected by JS -->
      <tr>
       <td colspan="8" class="p-8 text-center text-gray-500">
        <div class="flex flex-col items-center justify-center gap-3">
         <div class="loader"></div>
         <p>Fetching latest market data...</p>
        </div>
       </td>
      </tr>
     </tbody>
    </table>
   </div>
   <!-- Pagination / Load Info -->
   <div class="p-4 bg-dark-800 border-t border-dark-700 flex justify-between items-center text-xs text-gray-500">
    <span>Showing Top 50 Assets</span>
    <span id="last-updated">Updated: Just now</span>
   </div>
  </section>
  
 </main>
 
 <!-- Detailed Modal -->
 <div id="coin-modal" class="fixed inset-0 z-50 hidden">
  <!-- Backdrop -->
  <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" id="modal-backdrop"></div>
  
  <!-- Modal Content -->
  <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-11/12 max-w-2xl bg-dark-800 border border-dark-600 rounded-2xl shadow-2xl overflow-hidden animate-slide-up">
   
   <div class="bg-gradient-to-r from-dark-900 to-dark-800 p-6 border-b border-dark-700 flex justify-between items-start">
    <div class="flex items-center gap-4">
     <img id="modal-img" src="" alt="Coin" class="w-12 h-12 rounded-full shadow-lg">
     <div>
      <h2 id="modal-name" class="text-2xl font-bold text-white flex items-center gap-2">Bitcoin <span class="text-sm font-normal text-gray-400 bg-dark-700 px-2 py-0.5 rounded">BTC</span></h2>
      <div class="flex items-center gap-2 mt-1">
       <span class="bg-dark-700 text-xs px-2 py-0.5 rounded text-gray-300">Rank #<span id="modal-rank">1</span></span>
      </div>
     </div>
    </div>
    <button id="close-modal" class="text-gray-400 hover:text-white transition bg-dark-700 hover:bg-dark-600 rounded-full w-8 h-8 flex items-center justify-center">
     <i class="fa-solid fa-times"></i>
    </button>
   </div>
   
   <div class="p-6 overflow-y-auto max-h-[70vh]">
    <!-- Price Section -->
    <div class="flex flex-col sm:flex-row justify-between items-end mb-6 pb-6 border-b border-dark-700">
     <div>
      <span class="text-gray-400 text-sm">Current Price</span>
      <div class="text-4xl font-bold text-white tracking-tight" id="modal-price">$0.00</div>
     </div>
     <div class="mt-2 sm:mt-0 text-right">
      <div id="modal-change" class="text-lg font-bold bg-opacity-20 px-3 py-1 rounded-lg inline-block">+0.00%</div>
      <div class="text-xs text-gray-500 mt-1">24 Hour Change</div>
     </div>
    </div>
    
    <!-- 24h Range Bar -->
    <div class="mb-8">
     <div class="flex justify-between text-xs text-gray-400 mb-2">
      <span>Low: <span id="modal-low" class="text-gray-200"></span></span>
      <span>High: <span id="modal-high" class="text-gray-200"></span></span>
     </div>
     <div class="range-track w-full bg-dark-700 h-2 rounded-full overflow-hidden relative">
      <div class="absolute inset-0 bg-gradient-to-r from-red-500 via-yellow-500 to-green-500 opacity-20"></div>
      <div id="modal-range-marker" class="absolute top-0 bottom-0 w-2 bg-white shadow-[0_0_10px_white] transition-all duration-500" style="left: 50%"></div>
     </div>
     <p class="text-center text-xs text-gray-500 mt-1">24h Price Range Position</p>
    </div>
    
    <!-- Stats Grid -->
    <div class="grid grid-cols-2 gap-4">
     <div class="bg-dark-900/50 p-4 rounded-xl border border-dark-700">
      <div class="flex items-center gap-2 text-gray-400 text-xs mb-1">
       <i class="fa-solid fa-globe"></i> Market Cap
      </div>
      <div id="modal-mcap" class="text-lg font-semibold text-gray-200">-</div>
     </div>
     
     <div class="bg-dark-900/50 p-4 rounded-xl border border-dark-700">
      <div class="flex items-center gap-2 text-gray-400 text-xs mb-1">
       <i class="fa-solid fa-chart-simple"></i> Volume (24h)
      </div>
      <div id="modal-volume" class="text-lg font-semibold text-gray-200">-</div>
     </div>
     
     <div class="bg-dark-900/50 p-4 rounded-xl border border-dark-700">
      <div class="flex items-center gap-2 text-gray-400 text-xs mb-1">
       <i class="fa-solid fa-coins"></i> Circulating Supply
      </div>
      <div id="modal-supply" class="text-lg font-semibold text-gray-200">-</div>
     </div>
     
     <div class="bg-dark-900/50 p-4 rounded-xl border border-dark-700">
      <div class="flex items-center gap-2 text-gray-400 text-xs mb-1">
       <i class="fa-solid fa-trophy"></i> All Time High
      </div>
      <div id="modal-ath" class="text-lg font-semibold text-gray-200">-</div>
      <div id="modal-ath-change" class="text-xs text-red-400">-0.00%</div>
     </div>
    </div>
   </div>
   
   <div class="bg-dark-900 p-4 text-center border-t border-dark-700">
    <button id="modal-favorite-btn" class="text-sm font-medium text-gray-300 hover:text-yellow-400 transition flex items-center justify-center gap-2 mx-auto w-full py-2">
     <i class="fa-regular fa-star"></i> <span>Add to Favorites</span>
    </button>
   </div>
  </div>
 </div>
 
 <script>
  const CONFIG = {
   API_URL: 'https://api.coingecko.com/api/v3',
   PAGE_SIZE: 50, // More data
   REFRESH_RATE: 60000,
  };
  
  const STATE = {
   coins: [],
   globalStats: null,
   filter: 'all',
   currency: 'usd',
   sortBy: 'market_cap_rank',
   sortOrder: 'asc',
   favorites: JSON.parse(localStorage.getItem('cryptoFavorites')) || [],
   prevPrices: {},
   lastUpdated: null,
   isLoading: false
  };
  
  const els = {
   tableBody: document.getElementById('crypto-table-body'),
   searchInput: document.getElementById('search-input'),
   currencySelect: document.getElementById('currency-select'),
   filterBtns: document.querySelectorAll('.filter-btn'),
   refreshBtn: document.getElementById('refresh-btn'),
   lastUpdated: document.getElementById('last-updated'),
   globalCap: document.getElementById('global-cap'),
   btcDom: document.getElementById('btc-dom'),
   highlights: document.getElementById('highlights-section'),
   modal: {
    el: document.getElementById('coin-modal'),
    backdrop: document.getElementById('modal-backdrop'),
    closeBtn: document.getElementById('close-modal'),
    img: document.getElementById('modal-img'),
    name: document.getElementById('modal-name'),
    rank: document.getElementById('modal-rank'),
    price: document.getElementById('modal-price'),
    change: document.getElementById('modal-change'),
    low: document.getElementById('modal-low'),
    high: document.getElementById('modal-high'),
    rangeMarker: document.getElementById('modal-range-marker'),
    mcap: document.getElementById('modal-mcap'),
    volume: document.getElementById('modal-volume'),
    supply: document.getElementById('modal-supply'),
    ath: document.getElementById('modal-ath'),
    athChange: document.getElementById('modal-ath-change'),
    favBtn: document.getElementById('modal-favorite-btn')
   }
  };
 
  const formatCurrency = (num, currency = STATE.currency, compact = false) => {
   if (num === null || num === undefined) return '-';
   
   // Format options
   const opts = {
    style: 'currency',
    currency: currency.toUpperCase(),
   };
   
   if (compact) {
    opts.notation = 'compact';
    opts.maximumFractionDigits = 2;
   } else {
    // Handling small crypto prices (e.g. Shiba Inu)
    opts.maximumFractionDigits = num < 1 ? 6 : 2;
    opts.minimumFractionDigits = 2;
   }
   
   return new Intl.NumberFormat('en-US', opts).format(num);
  };
  
  const formatPercent = (num) => {
   if (num === null || num === undefined) return '-';
   return `${num >= 0 ? '+' : ''}${num.toFixed(2)}%`;
  };
  
  const formatNumber = (num) => {
   if (!num) return '-';
   return new Intl.NumberFormat('en-US', { notation: 'compact', maximumFractionDigits: 2 }).format(num);
  };
  
  const generateSparkline = (points, isUp) => {
   if (!points || points.length < 2) return '';
   const width = 120;
   const height = 40;
   const min = Math.min(...points);
   const max = Math.max(...points);
   const range = max - min || 1;
   
   // Create SVG path
   let pathD = `M 0 ${height - ((points[0] - min) / range * height)}`;
   const stepX = width / (points.length - 1);
   
   for (let i = 1; i < points.length; i++) {
    const x = i * stepX;
    const y = height - ((points[i] - min) / range * height);
    pathD += ` L ${x} ${y}`;
   }
   
   const color = isUp ? '#10b981' : '#ef4444';
   return `
   <svg width="${width}" height="${height}" fill="none" class="opacity-80">
    <path d="${pathD}" stroke="${color}" stroke-width="2" fill="none" />
   </svg>`;
  };
  
  // API Fetching
  const fetchMarketData = async () => {
   if (STATE.isLoading) return;
   STATE.isLoading = true;
   
   els.refreshBtn.classList.add('animate-spin');
   
   try {
    // Fetch Global Data
    const globalRes = await fetch(`${CONFIG.API_URL}/global`);
    const globalData = await globalRes.json();
    
    // Fetch Market Data (Top 50)
    const marketsRes = await fetch(`${CONFIG.API_URL}/coins/markets?vs_currency=${STATE.currency}&order=market_cap_desc&per_page=${CONFIG.PAGE_SIZE}&page=1&sparkline=true&price_change_percentage=1h,24h,7d`);
    
    if (!marketsRes.ok) {
     if (marketsRes.status === 429) throw new Error("Rate limit exceeded. Waiting...");
     throw new Error("API Error");
    }
    
    const marketsData = await marketsRes.json();
    
    // Store previous prices for flash animation
    marketsData.forEach(coin => {
     const oldCoin = STATE.coins.find(c => c.id === coin.id);
     if (oldCoin) {
      STATE.prevPrices[coin.id] = oldCoin.current_price;
     }
    });
    
    STATE.coins = marketsData;
    STATE.globalStats = globalData.data;
    STATE.lastUpdated = new Date();
    
    renderApp();
    
   } catch (error) {
    console.error("Fetch error:", error);
    els.lastUpdated.innerHTML = `<span class="text-red-400"><i class="fa-solid fa-circle-exclamation"></i> ${error.message}</span>`;
   } finally {
    STATE.isLoading = false;
    els.refreshBtn.classList.remove('animate-spin');
   }
  };
  
  // Filtering & Sorting
  const getProcessedData = () => {
   let data = [...STATE.coins];
   
   // Filter
   const query = els.searchInput.value.toLowerCase();
   if (query) {
    data = data.filter(c => c.name.toLowerCase().includes(query) || c.symbol.toLowerCase().includes(query));
   }
   
   switch (STATE.filter) {
    case 'favorites':
     data = data.filter(c => STATE.favorites.includes(c.id));
     break;
    case 'gainers':
     data = data.filter(c => c.price_change_percentage_24h > 0);
     break;
    case 'losers':
     data = data.filter(c => c.price_change_percentage_24h < 0);
     break;
   }
   
   // Sort
   data.sort((a, b) => {
    let valA = a[STATE.sortBy];
    let valB = b[STATE.sortBy];
    
    // Handle missing values
    if (valA === undefined) valA = 0;
    if (valB === undefined) valB = 0;
    
    return STATE.sortOrder === 'asc' ? valA - valB : valB - valA;
   });
   
   return data;
  };
  
  const toggleFavorite = (id, e) => {
   if (e) e.stopPropagation();
   
   if (STATE.favorites.includes(id)) {
    STATE.favorites = STATE.favorites.filter(fav => fav !== id);
   } else {
    STATE.favorites.push(id);
   }
   localStorage.setItem('cryptoFavorites', JSON.stringify(STATE.favorites));
   
   // Re-render only necessary parts (button or table)
   renderTable();
   if (!els.modal.el.classList.contains('hidden')) {
    updateModalFavBtn(id);
   }
  };
  
  const updateModalFavBtn = (coinId) => {
   const isFav = STATE.favorites.includes(coinId);
   const btn = els.modal.favBtn;
   if (isFav) {
    btn.innerHTML = '<i class="fa-solid fa-star text-yellow-500"></i> <span>Remove from Favorites</span>';
    btn.classList.add('text-yellow-400');
   } else {
    btn.innerHTML = '<i class="fa-regular fa-star"></i> <span>Add to Favorites</span>';
    btn.classList.remove('text-yellow-400');
   }
   // Update click handler
   btn.onclick = () => toggleFavorite(coinId);
  };
  
  // Rendering 
  const renderHeaderStats = () => {
   if (!STATE.globalStats) return;
   const cap = STATE.globalStats.total_market_cap[STATE.currency];
   const btc = STATE.globalStats.market_cap_percentage.btc;
   
   els.globalCap.textContent = formatNumber(cap);
   els.btcDom.textContent = `${btc.toFixed(1)}%`;
  };
  
  const renderHighlights = () => {
   if (STATE.coins.length === 0) return;
   
   // 1. Top Gainer
   const gainer = [...STATE.coins].sort((a, b) => b.price_change_percentage_24h - a.price_change_percentage_24h)[0];
   // 2. Highest Volume
   const volume = [...STATE.coins].sort((a, b) => b.total_volume - a.total_volume)[0];
   // 3. Trending (Simulated by 7d change for stability of free API)
   const trending = [...STATE.coins].sort((a, b) => b.price_change_percentage_7d_in_currency - a.price_change_percentage_7d_in_currency)[0];
   
   const createCard = (title, coin, iconClass, colorClass) => `
                <div class="glass-panel p-4 rounded-xl flex items-center justify-between cursor-pointer hover:bg-dark-800 transition" onclick="openModal('${coin.id}')">
                    <div>
                        <div class="text-xs text-gray-400 uppercase tracking-wider mb-1 flex items-center gap-2">
                            <i class="${iconClass}"></i> ${title}
                        </div>
                        <div class="font-bold text-lg text-white flex items-center gap-2">
                            <img src="${coin.image}" class="w-6 h-6 rounded-full"> ${coin.symbol.toUpperCase()}
                        </div>
                        <div class="text-sm font-mono mt-1 ${coin.price_change_percentage_24h >= 0 ? 'text-accent-green' : 'text-accent-red'}">
                            ${formatPercent(coin.price_change_percentage_24h)}
                        </div>
                    </div>
                    <div class="text-right">
                         <div class="text-sm font-bold text-gray-200">${formatCurrency(coin.current_price)}</div>
                    </div>
                </div>
            `;
   
   els.highlights.innerHTML = `
                ${createCard('Top Gainer', gainer, 'fa-solid fa-rocket', 'text-accent-green')}
                ${createCard('Highest Vol', volume, 'fa-solid fa-chart-bar', 'text-accent-blue')}
                ${createCard('7d Trend', trending, 'fa-solid fa-fire', 'text-orange-500')}
            `;
  };
  
  const renderTable = () => {
   const data = getProcessedData();
   
   if (data.length === 0) {
    els.tableBody.innerHTML = `<tr><td colspan="8" class="p-8 text-center text-gray-500">No assets found matching your criteria.</td></tr>`;
    return;
   }
   
   els.tableBody.innerHTML = data.map(coin => {
    const isUp = coin.price_change_percentage_7d_in_currency >= 0;
    const isFav = STATE.favorites.includes(coin.id);
    
    // Flash detection
    let flashClass = '';
    const prev = STATE.prevPrices[coin.id];
    if (prev && prev !== coin.current_price) {
     flashClass = coin.current_price > prev ? 'flash-up' : 'flash-down';
    }
    
    return `
                <tr class="group border-b border-dark-700 hover:bg-dark-800 transition cursor-pointer-row" onclick="openModal('${coin.id}')">
                    <td class="p-4 text-center">
                        <button onclick="toggleFavorite('${coin.id}', event)" class="hover:scale-110 transition">
                            <i class="${isFav ? 'fa-solid text-yellow-500' : 'fa-regular text-gray-600'} fa-star"></i>
                        </button>
                    </td>
                    <td class="p-4 text-center text-gray-500 text-xs">${coin.market_cap_rank}</td>
                    <td class="p-4">
                        <div class="flex items-center gap-3">
                            <img src="${coin.image}" alt="${coin.name}" class="w-8 h-8 rounded-full shadow-sm">
                            <div class="flex flex-col">
                                <span class="font-bold text-gray-200 text-sm">${coin.name}</span>
                                <span class="text-xs text-gray-500 uppercase">${coin.symbol}</span>
                            </div>
                        </div>
                    </td>
                    <td class="p-4 text-right font-mono font-medium text-gray-200 ${flashClass}">
                        ${formatCurrency(coin.current_price)}
                    </td>
                    <td class="p-4 text-right font-mono text-sm">
                        <span class="${coin.price_change_percentage_24h >= 0 ? 'text-accent-green' : 'text-accent-red'} bg-opacity-10 px-2 py-1 rounded">
                            ${formatPercent(coin.price_change_percentage_24h)}
                        </span>
                    </td>
                    <td class="p-4 text-right text-gray-400 text-sm hidden md:table-cell">
                        ${formatCurrency(coin.market_cap, STATE.currency, true)}
                    </td>
                    <td class="p-4 text-right text-gray-400 text-sm hidden lg:table-cell">
                        ${formatCurrency(coin.total_volume, STATE.currency, true)}
                    </td>
                    <td class="p-4 hidden sm:table-cell">
                        ${generateSparkline(coin.sparkline_in_7d?.price, isUp)}
                    </td>
                </tr>
            `
   }).join('');
  };
  
  const openModal = (coinId) => {
   const coin = STATE.coins.find(c => c.id === coinId);
   if (!coin) return;
   
   // Populate Modal
   els.modal.img.src = coin.image;
   els.modal.name.innerHTML = `${coin.name} <span class="text-sm font-normal text-gray-400 bg-dark-700 px-2 py-0.5 rounded">${coin.symbol.toUpperCase()}</span>`;
   els.modal.rank.textContent = coin.market_cap_rank;
   
   els.modal.price.textContent = formatCurrency(coin.current_price);
   els.modal.price.className = `text-4xl font-bold tracking-tight ${coin.price_change_percentage_24h >= 0 ? 'text-accent-green' : 'text-accent-red'}`;
   
   els.modal.change.textContent = formatPercent(coin.price_change_percentage_24h);
   els.modal.change.className = `text-lg font-bold bg-opacity-20 px-3 py-1 rounded-lg inline-block ${coin.price_change_percentage_24h >= 0 ? 'bg-green-500 text-accent-green' : 'bg-red-500 text-accent-red'}`;
   
   // Range Bar Logic
   els.modal.low.textContent = formatCurrency(coin.low_24h);
   els.modal.high.textContent = formatCurrency(coin.high_24h);
   
   if (coin.high_24h !== coin.low_24h) {
    const range = coin.high_24h - coin.low_24h;
    const position = ((coin.current_price - coin.low_24h) / range) * 100;
    els.modal.rangeMarker.style.left = `${Math.min(Math.max(position, 0), 100)}%`;
   }
   
   els.modal.mcap.textContent = formatCurrency(coin.market_cap, STATE.currency, true);
   els.modal.volume.textContent = formatCurrency(coin.total_volume, STATE.currency, true);
   els.modal.supply.textContent = `${formatNumber(coin.circulating_supply)} ${coin.symbol.toUpperCase()}`;
   els.modal.ath.textContent = formatCurrency(coin.ath);
   els.modal.athChange.textContent = `Down ${formatPercent(coin.ath_change_percentage)} from ATH`;
   
   updateModalFavBtn(coin.id);
   
   // Show Modal
   els.modal.el.classList.remove('hidden');
   document.body.style.overflow = 'hidden';
  };
  
  const closeModal = () => {
   els.modal.el.classList.add('hidden');
   document.body.style.overflow = '';
  };
  
  const renderApp = () => {
   renderHeaderStats();
   renderHighlights();
   renderTable();
   els.lastUpdated.textContent = `Updated: ${STATE.lastUpdated.toLocaleTimeString()}`;
  };
  
  // Event Listeners
  els.searchInput.addEventListener('input', renderTable);
  
  els.currencySelect.addEventListener('change', (e) => {
   STATE.currency = e.target.value;
   fetchMarketData();
  });
  
  els.filterBtns.forEach(btn => {
   btn.addEventListener('click', (e) => {
    // UI Toggle
    els.filterBtns.forEach(b => {
     b.classList.remove('bg-accent-blue', 'text-white');
     b.classList.add('bg-dark-800', 'text-gray-300');
    });
    const target = e.currentTarget;
    target.classList.remove('bg-dark-800', 'text-gray-300');
    target.classList.add('bg-accent-blue', 'text-white');
    
    // Logic
    STATE.filter = target.dataset.filter;
    renderTable();
   });
  });
  
  els.refreshBtn.addEventListener('click', fetchMarketData);
  
  // Sorting
  window.sortBy = (key) => {
   if (STATE.sortBy === key) {
    STATE.sortOrder = STATE.sortOrder === 'asc' ? 'desc' : 'asc';
   } else {
    STATE.sortBy = key;
    STATE.sortOrder = 'desc'; // Default to desc for numbers usually
   }
   renderTable();
  };
  
  // Modal Events
  els.modal.closeBtn.addEventListener('click', closeModal);
  els.modal.backdrop.addEventListener('click', closeModal);
  document.addEventListener('keydown', (e) => {
   if (e.key === 'Escape' && !els.modal.el.classList.contains('hidden')) {
    closeModal();
   }
  });
  
  // Initialization
  const init = () => {
   fetchMarketData();
   // Auto refresh
   setInterval(fetchMarketData, CONFIG.REFRESH_RATE);
  };
  
  document.addEventListener('DOMContentLoaded', init);
 </script>
</body>
</html>